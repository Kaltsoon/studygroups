var StudyGroupsApp=angular.module("StudyGroupsApp",["ngRoute","angularMoment","btford.markdown","ngSanitize","ui.gravatar","dbaq.emoji"]);StudyGroupsApp.config(function($routeProvider){function getUserSignedIn($rootScope,Api){return Api.getUserSignedIn().then(function(user){$rootScope.userSignedIn=user.data.id?user.data:null})}$routeProvider.when("/study-groups",{templateUrl:"study_group_list.html",controller:"StudyGroupListController",resolve:{userSignedIn:getUserSignedIn}}).when("/study-groups/:id/:key",{templateUrl:"study_group.html",controller:"StudyGroupController",resolve:{userSignedIn:getUserSignedIn}}).when("/study-groups/:id/:key/new-page",{templateUrl:"new_page.html",controller:"CreatePageController",resolve:{userSignedIn:getUserSignedIn}}).when("/study-groups/:groupId/:key/pages/:pageId",{templateUrl:"page.html",controller:"PageController",resolve:{userSignedIn:getUserSignedIn}}).when("/profile/:username",{templateUrl:"profile.html",controller:"ProfileController",resolve:{userSignedIn:getUserSignedIn}}).otherwise({redirectTo:"/study-groups"})}),StudyGroupsApp.run(function($rootScope,$window,Api){$rootScope.signOut=function(){Api.signOut().then(function(){$window.location.replace("/welcome")})}}),angular.module("StudyGroupsApp").run(["$templateCache",function($templateCache){$templateCache.put("new_page.html",'<ol class="breadcrumb">\n  <li><a ng-href="#/study-groups/{{group.id}}/{{group.key}}"><i class="fa fa-home" style="margin-right: 6px;"></i>{{group.name}}</a></li>\n  <li class="active">Create a page</li>\n</ol>\n\n<div class="page-header">\n  <h1>Create a page for study group "{{group.name}}"</h1>\n</div>\n\n<form>\n  <div class="form-group">\n    <label>Title</label>\n    <input type="text" required class="form-control" ng-model="newPage.title">\n  </div>\n\n  <div class="form-group">\n    <label>Content</label>\n    <p class="text-muted">\n      Tip: you can use <a href="http://markdowntutorial.com/" target="_blank">markdown</a> in this field.\n    </p>\n    <textarea class="form-control" ng-model="newPage.content" rows="20"></textarea>\n  </div>\n\n  <div class="form-group">\n    <button class="btn btn-success" type="submit" ng-click="createPage()">Create</button>\n  </div>\n</form>\n'),$templateCache.put("page.html",'<ol class="breadcrumb">\n  <li><a ng-href="#/study-groups/{{page.StudyGroup.id}}/{{page.StudyGroup.key}}"><i class="fa fa-home" style="margin-right: 6px;"></i>{{page.StudyGroup.name}}</a></li>\n  <li class="active">{{page.title}}</li>\n</ol>\n\n<div class="page-header button-header">\n  <h1>{{page.title}}</h1>\n\n  <button class="btn btn-danger pull-right" ng-click="removePage()" ng-if="userSignedIn.id == page.StudyGroup.User.id">\n    <i class="fa fa-times"></i> Remove page\n  </button>\n\n  <button class="btn btn-default pull-right" ng-class="{ \'active\': isEditing }" ng-click="toggleEditing()" style="margin-right: 10px" ng-if="userSignedIn.id == page.StudyGroup.User.id">\n    <i class="fa fa-pencil"></i> Edit page\n  </button>\n</div>\n\n<span class="highlighter-container">\n    <div class="panel panel-default">\n      <div class="panel-body">\n        <span class="highlight-color bg-success" tooltip content="\'Well explained!\'" ng-click="highlight(\'success\')"></span>\n        <span class="highlight-color bg-warning" tooltip content="\'I didn\\\'t quite get this...\'" ng-click="highlight(\'warning\')"></span>\n        <span class="highlight-color bg-danger" tooltip content="\'There\\\'s a serious problem here!\'" ng-click="highlight(\'danger\')"></span>\n      </div>\n    </div>\n</span>\n\n<div class="panel" ng-class="{ \'panel-default\': alertCounter == 0, \'panel-primary\': alertCounter > 0 }" id="chat-container" ng-controller="ChatController">\n  <div class="panel-heading" ng-click="toggleChat()">\n    <h3 class="panel-title"><i class="fa fa-comments"></i> {{page.StudyGroup.name}} chat <span class="pull-right" ng-show="alertCounter > 0"><i class="fa fa-bell"></i> {{alertCounter}}</span></h3>\n  </div>\n  <div class="panel-body" ng-show="chatIsShowing">\n    <div id="chat-messages">\n      <p class="text-muted" ng-if="messages.length == 0">\n        No messages yet.\n      </p>\n\n      <div class="media" ng-repeat="message in messages | orderBy: \'-createdAt\'">\n        <div class="media-left">\n          <img gravatar-src-once="message.User.email" class="mini-portrait media-object" gravatar-size="30" style="margin-right: 2px;">\n        </div>\n        <div class="media-body">\n          <p>\n            <a ng-href="#/profile/{{message.User.username}}">{{message.User.username}}</a>:\n            <span ng-bind-html="message.text | emoji"></span>\n            <span am-time-ago="message.createdAt" class="text-muted"></span>\n          </p>\n        </div>\n      </div>\n    </div>\n    <form ng-submit="sendChatMessage()">\n      <p class="text-muted">\n        Tip: you can use <a href="http://www.emoji-cheat-sheet.com/" target="_blank">emojis</a> in this field.\n      </p>\n      <input type="text" required class="form-control" placeholder="Type your message here..." ng-model="newMessage">\n      <button type="submit" style="display: none"></button>\n    </form>\n  </div>\n</div>\n\n<div class="row">\n  <div class="col-md-9">\n    <p class="text-muted">\n      Created at {{page.createdAt | amDateFormat:\'MMMM Do YYYY\' }} · Latest update <span am-time-ago="page.updatedAt"></span>\n    </p>\n\n    <div ng-show="isEditing" ng-if="userSignedIn.id == page.StudyGroup.User.id">\n      <form ng-submit="updatePage()">\n        <div class="form-group">\n          <label>Title</label>\n          <input type="text" required class="form-control" ng-model="editedPage.title">\n        </div>\n        <div class="form-group">\n          <label>Content</label>\n          <p class="text-muted">\n            Tip: you can use <a href="http://markdowntutorial.com/" target="_blank">markdown</a> in this field.\n          </p>\n          <textarea rows="25" required class="form-control" ng-model="editedPage.content"></textarea>\n        </div>\n        <div class="form-group">\n          <button type="submit" class="btn btn-default">Save</button>\n        </div>\n      </form>\n    </div>\n\n    <div ng-hide="isEditing">\n      <p>\n        <button class="btn btn-warning" ng-if="userSignedIn.id == page.StudyGroup.User.id" ng-click="removeHighlightings()"><i class="fa fa-eraser"></i> Clear highlightings</button>\n      </p>\n\n      <p btf-markdown="page.content" highlighter highlight-content="page.content" currently-highlighted-section="currentlyHighlightedSection" highlighted-sections="page.Highlights"></p>\n    </div>\n  </div>\n\n  <div class="col-md-3">\n    <div class="alert alert-info" ng-hide="page.StudyGroup.Pages.length > 0" ng-if="userSignedIn.id == page.StudyGroup.User.id">\n      You don\'t have any pages yet. Would you like to <a href="#/study-groups/{{page.StudyGroup.id}}/{{page.StudyGroup.key}}/new-page">create a page</a>?\n    </div>\n\n    <div ng-show="page.StudyGroup.Pages.length > 0">\n      <h4>Pages</h4>\n      <ul class="nav nav-pills nav-stacked" style="margin-bottom: 10px">\n        <li ng-repeat="p in page.StudyGroup.Pages" ng-class="{ \'active\': p.id == page.id }">\n          <a ng-href="#/study-groups/{{p.StudyGroup.id}}/{{p.StudyGroup.key}}/pages/{{p.id}}">{{p.title}}</a>\n        </li>\n      </ul>\n    </div>\n\n    <p>\n      <a ng-href="#/study-groups/{{page.StudyGroup.id}}/{{page.StudyGroup.key}}/new-page" class="btn btn-success btn-block" ng-if="userSignedIn.id == page.StudyGroup.User.id">\n        <i class="fa fa-plus"></i> Create a page\n      </a>\n    </p>\n  </div>\n</div>\n'),$templateCache.put("profile.html",'<div class="page-header button-header">\n  <h1>{{user.username}}</h1>\n\n  <button class="btn btn-danger pull-right" ng-click="removeProfile()" ng-if="userSignedIn.id == user.id">\n    <i class="fa fa-times"></i> Remove profile\n  </button>\n\n  <button class="btn btn-default pull-right" ng-class="{ \'active\': isEditing }" ng-click="toggleEditing()" style="margin-right: 10px" ng-if="userSignedIn.id == user.id">\n    <i class="fa fa-pencil"></i> Edit profile\n  </button>\n</div>\n\n<div class="media">\n  <div class="media-left">\n    <img gravatar-src-once="user.email" class="large-portrait media-object" gravatar-size="100">\n  </div>\n  <div class="media-body">\n    <p class="text-muted">\n      Member since {{user.createdAt | amDateFormat:\'MMMM Do YYYY\' }}\n    </p>\n    <p btf-markdown="user.description" ng-hide="isEditing"></p>\n\n    <div ng-if="userSignedIn.id == user.id" ng-show="isEditing">\n      <form ng-submit="updateProfile()">\n        <div class="form-group">\n          <label>Email</label>\n          <input type="email" ng-model="editedUser.email" required class="form-control">\n        </div>\n        <div class="form-group">\n          <label>Description</label>\n          <p class="text-muted">\n            Tip: you can use <a href="http://markdowntutorial.com/" target="_blank">markdown</a> in this field.\n          </p>\n          <textarea rows="10" required class="form-control" ng-model="editedUser.description"></textarea>\n        </div>\n        <div class="form-group">\n          <button type="submit" class="btn btn-default">Save</button>\n        </div>\n      </form>\n    </div>\n  </div>\n</div>\n'),$templateCache.put("study_group.html",'<ol class="breadcrumb">\n  <li class="acitve"><i class="fa fa-home" style="margin-right: 6px;"></i>{{group.name}}</li>\n</ol>\n<div class="page-header button-header">\n  <h1>{{group.name}}</h1>\n\n  <button class="btn btn-danger pull-right" ng-click="removeStudyGroup()" ng-if="userSignedIn.id == group.User.id">\n    <i class="fa fa-times"></i> Remove study group\n  </button>\n\n  <button class="btn btn-default pull-right" ng-class="{ \'active\': isEditing }" ng-click="toggleEditing()" style="margin-right: 10px" ng-if="userSignedIn.id == group.User.id">\n    <i class="fa fa-pencil"></i> Edit study group\n  </button>\n</div>\n\n<div class="panel" ng-class="{ \'panel-default\': alertCounter == 0, \'panel-primary\': alertCounter > 0 }" id="chat-container" ng-controller="ChatController">\n  <div class="panel-heading" ng-click="toggleChat()">\n    <h3 class="panel-title"><i class="fa fa-comments"></i> {{group.name}} chat <span class="pull-right" ng-show="alertCounter > 0"><i class="fa fa-bell"></i> {{alertCounter}}</span></h3>\n  </div>\n  <div class="panel-body" ng-show="chatIsShowing">\n    <div id="chat-messages">\n      <p class="text-muted" ng-if="messages.length == 0">\n        No messages yet.\n      </p>\n\n      <div class="media" ng-repeat="message in messages | orderBy: \'-createdAt\'">\n        <div class="media-left">\n          <img gravatar-src-once="message.User.email" class="mini-portrait media-object" gravatar-size="30" style="margin-right: 2px;">\n        </div>\n        <div class="media-body">\n          <p>\n            <a ng-href="#/profile/{{message.User.username}}">{{message.User.username}}</a>:\n            <span ng-bind-html="message.text | emoji"></span>\n            <span am-time-ago="message.createdAt" class="text-muted"></span>\n          </p>\n        </div>\n      </div>\n    </div>\n    <form ng-submit="sendChatMessage()">\n      <p class="text-muted">\n        Tip: you can use <a href="http://www.emoji-cheat-sheet.com/" target="_blank">emojis</a> in this field.\n      </p>\n      <input type="text" required class="form-control" placeholder="Type your message here..." ng-model="newMessage">\n      <button type="submit" style="display: none"></button>\n    </form>\n  </div>\n</div>\n\n<div class="row">\n  <div class="col-md-9">\n    <p class="text-muted">\n      Owned by <a ng-href="#/profile/{{group.User.username}}">{{group.User.username}}</a> · Created at {{group.createdAt | amDateFormat:\'dddd, MMMM Do YYYY\' }} · Latest update <span am-time-ago="group.updatedAt"></span>\n    </p>\n\n    <p class="text-muted">\n      Readers:\n    </p>\n\n    <p>\n      <a ng-href="#/profile/{{reader.User.username}}" ng-repeat="reader in group.Readers" tooltip content="reader.User.username"><img gravatar-src-once="reader.User.email" class="mini-portrait" style="margin: 1px"></a>\n    </p>\n\n    <div class="form-group" ng-if="userSignedIn.id == group.User.id">\n      <label>Share URL</label>\n      <input type="text" ng-model="shareUrl" class="form-control">\n    </div>\n\n    <div ng-show="isEditing" ng-if="userSignedIn.id == group.User.id">\n      <form ng-submit="updateStudyGroup()">\n        <div class="form-group">\n          <label>Name</label>\n          <input type="text" required class="form-control" ng-model="editedGroup.name">\n        </div>\n        <div class="form-group">\n          <label>Description</label>\n          <p class="text-muted">\n            Tip: you can use <a href="http://markdowntutorial.com/" target="_blank">markdown</a> in this field.\n          </p>\n          <textarea rows="10" required class="form-control" ng-model="editedGroup.description"></textarea>\n        </div>\n        <div class="form-group">\n          <button type="submit" class="btn btn-default">Save</button>\n        </div>\n      </form>\n    </div>\n\n    <p btf-markdown="group.description" ng-hide="isEditing"></p>\n\n  </div>\n  <div class="col-md-3">\n    <div class="alert alert-info" ng-hide="group.Pages.length > 0" ng-if="userSignedIn.id == group.User.id">\n      You don\'t have any pages yet. Would you like to <a href="#/study-groups/{{group.id}}/{{group.key}}/new-page">create a page</a>?\n    </div>\n\n    <div ng-show="group.Pages.length > 0">\n      <h4>Pages</h4>\n      <ul class="nav nav-pills nav-stacked" style="margin-bottom: 10px">\n        <li ng-repeat="page in group.Pages">\n          <a ng-href="#/study-groups/{{group.id}}/{{group.key}}/pages/{{page.id}}">{{page.title}}</a>\n        </li>\n      </ul>\n    </div>\n\n    <p>\n      <a ng-href="#/study-groups/{{group.id}}/{{group.key}}/new-page" class="btn btn-success btn-block" ng-if="userSignedIn.id == group.User.id">\n        <i class="fa fa-plus"></i> Create a page\n      </a>\n    </p>\n  </div>\n</div>\n'),$templateCache.put("study_group_list.html",'<div class="page-header">\n  <h1>My study groups</h1>\n</div>\n\n<p>\n  <button class="btn btn-success" ng-click="toggleStudyGroupForm()" ng-class="{ \'active\': studyGroupFormIsShowing }">\n    <i class="fa fa-plus"></i> Create a study group\n  </button>\n</p>\n\n<form ng-show="studyGroupFormIsShowing" ng-submit="createStudyGroup()">\n  <div class="form-group">\n    <label>Name</label>\n    <input type="text" ng-model="newStudyGroup.name" required class="form-control">\n  </div>\n\n  <div class="form-group">\n    <label>Description</label>\n    <p class="text-muted">\n      Tip: you can use <a href="http://markdowntutorial.com/" target="_blank">markdown</a> in this field.\n    </p>\n    <textarea rows="10" ng-model="newStudyGroup.description" required class="form-control"></textarea>\n  </div>\n\n  <div class="form-group">\n    <button type="submit" class="btn btn-success">Create</button>\n  </div>\n</form>\n\n<table class="table table-striped table-bordered">\n  <thead>\n    <tr>\n      <th>Name</th>\n      <th>Pages</th>\n      <th>Readers</th>\n      <th>My status</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat="group in groups">\n      <td><a ng-href="#/study-groups/{{group.id}}/{{group.key}}">{{group.name}}</a></td>\n      <td><span class="badge">{{group.Pages.length}}</span></td>\n      <td><span class="badge">{{group.Readers.length}}</span></td>\n      <td>\n        <span class="label label-primary" ng-show="group.User.id == userSignedIn.id">Owner</span>\n        <span class="label label-default" ng-show="group.User.id != userSignedIn.id">Reader</span>\n      </td>\n    </tr>\n  </tbody>\n</table>\n')}]),StudyGroupsApp.service("Api",function($http){this.getUserSignedIn=function(){return $http.get("/users/user-signed-in")},this.getUser=function(username){return $http.get("/users/"+username)},this.updateUser=function(user){return $http.post("/users/"+user.id+"/update",user)},this.removeUser=function(id){return $http.post("/users/"+id+"/remove")},this.getChatMessages=function(groupId){return $http.get("/chat-messages/from-group/"+groupId)},this.getUsersStudyGroups=function(){return $http.get("/study-groups")},this.getStudyGroup=function(id,key){return $http.get("/study-groups/"+id+"/"+key)},this.createStudyGroup=function(studyGroup){return $http.post("/study-groups/create",studyGroup)},this.removeStudyGroup=function(id){return $http.post("/study-groups/"+id+"/remove")},this.updateStudyGroup=function(group){return $http.post("/study-groups/"+group.id+"/update",group)},this.getPage=function(id,key){return $http.get("/pages/"+id+"/"+key)},this.removePage=function(id){return $http.post("/pages/"+id+"/remove")},this.updatePage=function(page){return $http.post("/pages/"+page.id+"/update",page)},this.createPage=function(page){return $http.post("/pages/create",page)},this.createHighlight=function(highlight){return $http.post("/highlights/create",highlight)},this.removeHighlightings=function(pageId){return $http.post("/highlights/remove-all/"+pageId)},this.signOut=function(){return $http.post("/users/sign-out")}}),StudyGroupsApp.service("SocketIo",function(){var socket=io();this.on=function(type,callback){socket.on(type,callback)},this.emit=function(type,content){socket.emit(type,content)}}),StudyGroupsApp.controller("ChatController",function($scope,$routeParams,$rootScope,Api,SocketIo){$scope.alertCounter=0,SocketIo.on("chat-message",function(message){var currentGroupId=$routeParams.id||$routeParams.groupId,parsedMessage=JSON.parse(message);parsedMessage.StudyGroupId==currentGroupId&&$scope.$apply(function(){$scope.chatIsShowing||$scope.alertCounter++,$scope.messages.push(parsedMessage)})}),Api.getChatMessages($routeParams.id||$routeParams.groupId).then(function(messages){$scope.messages=messages.data}),$scope.toggleChat=function(){$scope.chatIsShowing=!$scope.chatIsShowing,$scope.chatIsShowing&&($scope.alertCounter=0)},$scope.sendChatMessage=function(){if($scope.newMessage){var messageToSend={UserId:$rootScope.userSignedIn.id,createdAt:new Date,StudyGroupId:$routeParams.id||$routeParams.groupId,text:$scope.newMessage,User:$rootScope.userSignedIn};SocketIo.emit("chat-message",JSON.stringify(messageToSend)),$scope.newMessage=""}}}),StudyGroupsApp.controller("CreatePageController",function($scope,$location,$rootScope,$routeParams,Api){$scope.newPage={},Api.getStudyGroup($routeParams.id,$routeParams.key).then(function(group){$scope.group=group.data,$scope.group.UserId!=$rootScope.userSignedIn.id&&$location.path("/study-groups")}),$scope.createPage=function(){$scope.newPage.StudyGroupId=$routeParams.id,Api.createPage($scope.newPage).then(function(page){$location.path("/study-groups/"+$routeParams.id+"/"+$routeParams.key+"/pages/"+page.data.id)})}}),StudyGroupsApp.controller("PageController",function($scope,$location,$routeParams,Api){$scope.editedPage={},Api.getPage($routeParams.pageId,$routeParams.key).then(function(page){$scope.page=page.data,$scope.editedPage=_.pick($scope.page,"title","content","id")})["catch"](function(){$location.path("/study-groups")}),$scope.toggleEditing=function(){$scope.isEditing=!$scope.isEditing},$scope.highlight=function(type){if($scope.currentlyHighlightedSection&&$scope.currentlyHighlightedSection.split(" ").length>=3){var highlight={type:type,text:_.trim($scope.currentlyHighlightedSection)};Api.createHighlight(_.extend(highlight,{PageId:$routeParams.pageId})),$scope.page.Highlights.push(highlight)}},$scope.removeHighlightings=function(){confirm("Are you sure you wan't to remove all highlightings?")&&Api.removeHighlightings($routeParams.pageId).then(function(){$scope.page.Highlights=[]})},$scope.updatePage=function(){Api.updatePage($scope.editedPage).then(function(){$scope.isEditing=!1,_.extend($scope.page,$scope.editedPage)})},$scope.removePage=function(){confirm("Are you sure you wan't to remove this page?")&&Api.removePage($routeParams.pageId).then(function(){$location.path("/study-groups/"+$routeParams.groupId+"/"+$routeParams.key)})}}),StudyGroupsApp.controller("ProfileController",function($scope,$routeParams,$window,Api){$scope.editedUser={},Api.getUser($routeParams.username).then(function(user){$scope.user=user.data,$scope.editedUser=_.pick($scope.user,"email","description","id")}),$scope.toggleEditing=function(){$scope.isEditing=!$scope.isEditing},$scope.updateProfile=function(){Api.updateUser($scope.editedUser).then(function(){$scope.isEditing=!1,_.extend($scope.user,$scope.editedUser)})},$scope.removeProfile=function(){confirm("Are you sure you wan't to remove your profile?")&&Api.removeUser($scope.user.id).then(function(){$window.location.replace("/welcome")})}}),StudyGroupsApp.controller("StudyGroupController",function($scope,$location,$routeParams,Api){$scope.editedGroup={},$scope.shareUrl=$location.absUrl(),Api.getStudyGroup($routeParams.id,$routeParams.key).then(function(group){$scope.group=group.data,$scope.editedGroup=_.pick($scope.group,"name","description","id")})["catch"](function(){$location.path("/study-groups")}),$scope.toggleEditing=function(){$scope.isEditing=!$scope.isEditing},$scope.updateStudyGroup=function(){Api.updateStudyGroup($scope.editedGroup).then(function(){$scope.isEditing=!1,_.extend($scope.group,$scope.editedGroup)})},$scope.removeStudyGroup=function(){confirm("Are you sure you wan't to remove this study group?")&&Api.removeStudyGroup($routeParams.id).then(function(){$location.path("/study-groups")})}}),StudyGroupsApp.controller("StudyGroupListController",function($scope,$location,Api){Api.getUsersStudyGroups().then(function(groups){$scope.groups=groups.data}),$scope.newStudyGroup={},$scope.toggleStudyGroupForm=function(){$scope.studyGroupFormIsShowing=!$scope.studyGroupFormIsShowing},$scope.createStudyGroup=function(){Api.createStudyGroup($scope.newStudyGroup).then(function(group){$location.path("/study-groups/"+group.data.id+"/"+group.data.key)})}}),function($){function get_previoussibling(n){var x,y=n;try{for(x=n.previousSibling;x&&1!=x.nodeType;)y=x,x=x.previousSibling}catch(err){return console.log(err),topOffset=-15,y}return x?x:y}$.event.special.tripleclick={setup:function(data,namespaces){var elem=this,$elem=jQuery(elem);$elem.bind("click",jQuery.event.special.tripleclick.handler)},teardown:function(namespaces){var elem=this,$elem=jQuery(elem);$elem.unbind("click",jQuery.event.special.tripleclick.handler)},handler:function(event){var elem=this,$elem=jQuery(elem),clicks=$elem.data("clicks")||0;clicks+=1,3===clicks&&(clicks=0,event.type="tripleclick",jQuery.event.dispatch.apply(this,arguments)),$elem.data("clicks",clicks)}};var methods={init:function(options){var selText,settings=$.extend({selector:".highlighter-container",minWords:0,complete:function(){}},options),numClicks=0,topOffset=0,leftOffset=0,isDown=!1;return this.each(function(){function insertSpanAfterSelection(clicks){var html="<span class='dummy'><span>";if(topOffset=0,leftOffset=0,numClicks===clicks){var sel,range,expandedSelRange,position,isIE="Microsoft Internet Explorer"===navigator.appName;if(window.getSelection){if(sel=window.getSelection(),selText=sel.toString(),""===$.trim(selText)||selText.split(" ").length<settings.minWords)return;if(sel.getRangeAt&&sel.rangeCount){range=window.getSelection().getRangeAt(0),expandedSelRange=range.cloneRange(),expandedSelRange.collapse(!1);var el=document.createElement("div");el.innerHTML=html;var dummy=document.createElement("span");if(0===range.startOffset&&0===range.endOffset){var cont=expandedSelRange.startContainer,prev=get_previoussibling(cont);try{expandedSelRange.selectNode(prev.lastChild)}catch(err){leftOffset=40,topOffset=-15,expandedSelRange.selectNode(prev)}expandedSelRange.collapse(!1)}else 0===range.endOffset&&(topOffset=-25,leftOffset=40);if(numClicks!==clicks)return;$(settings.selector).hide(),isIE||$.trim(selText)!==$.trim(expandedSelRange.startContainer.innerText)?isIE||$.trim(selText)!==$.trim(expandedSelRange.endContainer.innerText)?(expandedSelRange.insertNode(dummy),position=$(dummy).offset(),dummy.parentNode.removeChild(dummy)):(expandedSelRange.endContainer.innerHTML+="<span class='dummy'>&nbsp;</span>",position=$(".dummy").offset(),$(".dummy").remove()):(expandedSelRange.startContainer.innerHTML+="<span class='dummy'>&nbsp;</span>",position=$(".dummy").offset(),$(".dummy").remove())}}else if(document.selection&&document.selection.createRange){if(range=document.selection.createRange(),expandedSelRange=range.duplicate(),selText=expandedSelRange.text,""===$.trim(selText)||selText.split(" ").length<settings.minWords)return;range.collapse(!1),range.pasteHTML(html),expandedSelRange.setEndPoint("EndToEnd",range),expandedSelRange.select(),position=$(".dummy").offset(),$(".dummy").remove()}$(settings.selector).css("top",position.top+topOffset+"px"),$(settings.selector).css("left",position.left+leftOffset+"px"),$(settings.selector).show(300,function(){settings.complete(selText)})}}$(settings.selector).hide(),$(settings.selector).css("position","absolute"),$(document).bind("mouseup.highlighter",function(e){isDown&&(numClicks=1,clicks=0,setTimeout(function(){insertSpanAfterSelection(1)},300),isDown=!1)}),$(this).bind("mouseup.highlighter",function(e){numClicks=1,clicks=0,setTimeout(function(){insertSpanAfterSelection(1)},300)}),$(this).bind("tripleclick.highlighter",function(e){numClicks=3,setTimeout(function(){insertSpanAfterSelection(3)},200)}),$(this).bind("dblclick.highlighter",function(e){numClicks=2,setTimeout(function(){insertSpanAfterSelection(2)},300)}),$(this).bind("mousedown.highlighter",function(e){$(settings.selector).hide(),isDown=!0})})},destroy:function(content){return this.each(function(){$(document).unbind("mouseup.highlighter"),$(this).unbind("mouseup.highlighter"),$(this).unbind("tripleclick.highlighter"),$(this).unbind("dblclick.highlighter"),$(this).unbind("mousedown.highlighter")})}};$.fn.highlighter=function(method){return methods[method]?methods[method].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof method&&method?void $.error("Method "+method+" does not exist on jQuery.highlighter"):methods.init.apply(this,arguments)}}(jQuery),StudyGroupsApp.directive("highlighter",function(){return{scope:{highlightContent:"=",currentlyHighlightedSection:"=",highlightedSections:"="},link:function(scope,elem,attrs){function highlight(){0==scope.highlightedSections.length&&$(elem).find(".highlighted-text").contents().unwrap();var updatedContent=$(elem).html();scope.highlightedSections.forEach(function(section){var textIndex=updatedContent.indexOf(section.text);updatedContent=updatedContent.substring(0,textIndex)+'<span data-id="'+section.id+'" class="highlighted-text bg-'+section.type+'">'+updatedContent.substring(textIndex,textIndex+section.text.length)+"</span>"+updatedContent.substring(textIndex+section.text.length,updatedContent.length)}),$(elem).html(updatedContent)}scope.$watch("highlightedSections",function(sections){$(elem).html()&&highlight()},!0),scope.$watch("highlightContent",function(content){content&&(highlight(),$(elem).highlighter({minWords:3,complete:function(data){scope.$apply(function(){scope.currentlyHighlightedSection=data})}}))})}}}),StudyGroupsApp.directive("tooltip",function(){return{scope:{content:"="},restrict:"A",link:function(scope,element,attrs){$(element).tooltip({container:"body",title:scope.content})}}});